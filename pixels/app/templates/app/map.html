<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Harita Seçimi (Antrasit)</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      overflow: hidden;
      height: 100%;
      background: #111;
    }
    #container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    #mapImage {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }
    #gridCanvas {
      position: absolute;
      top: 0; left: 0;
      z-index: 1;
      pointer-events: auto;
      cursor: crosshair;
    }
    #info {
      position: absolute;
      top: 10px; right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      font-family: Arial;
      z-index: 2;
    }
    #debug {
      position: absolute;
      bottom: 10px; left: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      z-index: 2;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Base64 encoded dünya haritası -->
    <img id="mapImage" src="/static/app/map4.png" />
    <canvas id="gridCanvas"></canvas>
    <div id="info">
      <div>Seçilen Hücre: <span id="selectedCount">0</span></div>
      <div>Son Tıklama: <span id="lastClick">-</span></div>
    </div>
    <div id="debug">
      <div id="debugText">Harita yükleniyor...</div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("gridCanvas");
    const ctx = canvas.getContext("2d");
    const selected = new Set();

    const cols = 400;
    const rows = 250;

    const img = document.getElementById("mapImage");
    const selectedCountEl = document.getElementById("selectedCount");
    const lastClickEl = document.getElementById("lastClick");
    const debugEl = document.getElementById("debugText");

    let imageDataCanvas = null;
    let imageCtx = null;
    let imageData = null;

    function resize() {
      canvas.width = img.clientWidth;
      canvas.height = img.clientHeight;
      
      if (imageDataCanvas === null) {
        imageDataCanvas = document.createElement("canvas");
        imageDataCanvas.width = img.naturalWidth;
        imageDataCanvas.height = img.naturalHeight;
        imageCtx = imageDataCanvas.getContext("2d");
      }
      
      imageCtx.clearRect(0, 0, imageDataCanvas.width, imageDataCanvas.height);
      imageCtx.drawImage(img, 0, 0, imageDataCanvas.width, imageDataCanvas.height);
      
      // Tüm image data'yı bir kez al
      imageData = imageCtx.getImageData(0, 0, imageDataCanvas.width, imageDataCanvas.height);
      
      debugEl.textContent = `Harita: ${imageDataCanvas.width}x${imageDataCanvas.height} | Canvas: ${canvas.width}x${canvas.height}`;
      
      draw();
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const cellW = canvas.width / cols;
      const cellH = canvas.height / rows;

      ctx.fillStyle = "rgba(34,197,94,0.6)";
      ctx.strokeStyle = "rgba(34,197,94,0.8)";
      ctx.lineWidth = 1;

      selected.forEach(key => {
        const [x, y] = key.split(',').map(Number);
        ctx.fillRect(x * cellW, y * cellH, cellW, cellH);
        if (canvas.width > 1000) {
          ctx.strokeRect(x * cellW, y * cellH, cellW, cellH);
        }
      });

      selectedCountEl.textContent = selected.size;
    }

    function isLandCell(col, row) {
      if (!imageData) return false;

      const x = Math.floor((col + 0.5) * (imageDataCanvas.width / cols));
      const y = Math.floor((row + 0.5) * (imageDataCanvas.height / rows));

      // Sınır kontrolü
      if (x < 0 || x >= imageDataCanvas.width || y < 0 || y >= imageDataCanvas.height) {
        return false;
      }

      const index = (y * imageDataCanvas.width + x) * 4;
      const r = imageData.data[index];
      const g = imageData.data[index + 1];
      const b = imageData.data[index + 2];

      const brightness = (r + g + b) / 3;
      
      // Debug bilgisi göster
      debugEl.innerHTML = `
        Hücre: (${col}, ${row})<br>
        Piksel: (${x}, ${y})<br>
        RGB: (${r}, ${g}, ${b})<br>
        Brightness: ${brightness.toFixed(1)}<br>
        ${brightness > 100 ? '🏔️ KARA' : '🌊 DENİZ'}
      `;

      // Brightness > 100 olan alanlar kara (seçilebilir)
      return brightness > 100;
    }

    canvas.addEventListener("click", e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const col = Math.floor((x / canvas.width) * cols);
      const row = Math.floor((y / canvas.height) * rows);
      const key = `${col},${row}`;

      lastClickEl.textContent = `(${col}, ${row})`;

      if (!isLandCell(col, row)) {
        console.log("🌊 Bu hücre deniz, seçilemez.");
        return;
      }

      if (selected.has(key)) {
        selected.delete(key);
        console.log("❌ Hücre seçimi kaldırıldı:", key);
      } else {
        selected.add(key);
        console.log("✅ Hücre seçildi:", key);
      }

      draw();
    });

    // Mouse hareket ettiğinde hangi hücrenin üzerinde olduğunu göster
    canvas.addEventListener("mousemove", e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const col = Math.floor((x / canvas.width) * cols);
      const row = Math.floor((y / canvas.height) * rows);

      if (col >= 0 && col < cols && row >= 0 && row < rows) {
        isLandCell(col, row); // Bu debug bilgisini günceller
      }
    });

    window.addEventListener("resize", resize);
    img.addEventListener("load", resize);
  </script>
</body>
</html>